<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game - Wombat Adventures</title>
    <link rel="stylesheet" href="gamestyles.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            min-height: 100vh;
            display: flex;
        }
        .side-menu {
            width: 180px;
            background: #024b0c;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 100;
            padding-top: 60px; /* space for top menu */
        }
        .side-menu a {
            color: #fff;
            text-decoration: none;
            padding: 18px 24px;
            font-size: 1.1rem;
            border-bottom: 1px solid #28543c;
            transition: background 0.2s;
        }
        .side-menu a:hover {
            background: #28543c;
        }
        .top-menu {
            position: fixed;
            top: 0;
            left: 180px;
            right: 0;
            height: 60px;
            background: #024b0c;
            color: #fff;
            display: flex;
            align-items: center;
            padding: 0 32px;
            z-index: 101;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .main-content {
            margin-left: 180px;
            margin-top: 60px;
            padding: 32px;
            flex: 1;
            background: #f7f7f7;
            min-height: calc(100vh - 60px);
        }
    </style>
</head>
<body>
    <nav class="side-menu">
        <div id="sideCharInfo" style="display:flex;flex-direction:column;align-items:center;padding:18px 0 12px 0;">
            <img id="sideCharImg" src="" alt="Character" style="width:144px;height:192px;border-radius:8px;object-fit:cover;box-shadow:0 2px 8px rgba(0,0,0,0.10);margin-bottom:10px;display:none;">
            <div id="sideCharLevel" style="font-size:1.1rem;font-weight:bold;margin-bottom:4px;display:none;"></div>
            <div id="sideCharClass" style="font-size:1rem;color:#e0e0e0;display:none;"></div>
            <div id="sideCharXPBar" style="width:144px;height:22px;background:#222;border-radius:8px;margin-top:12px;position:relative;overflow:hidden;display:none;">
                <div id="xpFill" style="height:100%;background:#1a7f3c;border-radius:8px;position:absolute;left:0;top:0;"></div>
                <span id="xpText" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);color:#fff;font-weight:bold;font-size:0.78rem;"></span>
            </div>
            <div id="sideCharProps" style="width:144px;margin-top:10px;padding:7px 10px 7px 10px;font-size:1rem;color:#fff;display:none;"></div>
        </div>
        <button id="sideInventoryBtn" style="width:144px;margin:16px auto 0 auto;padding:10px 0;background:#1a7f3c;color:#fff;border:none;border-radius:6px;font-size:1.05rem;font-weight:500;cursor:pointer;transition:background 0.2s;display:block;">Inventory</button>
    </nav>
    <header class="top-menu">
        <span style="font-size:1.3rem;font-weight:bold;">Wombat Adventures</span>
        <div style="flex:1;"></div>
        <div id="plaiBalanceDisplay" style="margin-right:24px;font-size:1.08rem;background:#1a7f3c;border-radius:4px;padding:7px 18px;color:#fff;display:flex;align-items:center;gap:6px;">
            <img src="../assets/sprites/plai.png" alt="PLAI" style="width:22px;height:22px;vertical-align:middle;"> 
            <span id="plaiBalance">0.00</span> PLAI
        </div>
        <button id="connectWalletBtn" style="margin-right:16px;padding:8px 18px;font-size:1rem;border:none;border-radius:4px;background:#1a7f3c;color:#fff;cursor:pointer;transition:background 0.2s;">Connect Wallet</button>
        <button id="quitGameBtn" style="padding:8px 18px;font-size:1rem;border:none;border-radius:4px;background:#b22222;color:#fff;cursor:pointer;transition:background 0.2s;">Quit game</button>
    </header>
    <main class="main-content">
        <!-- Game content goes here -->
    </main>
    <div class="inventory-popup" id="inventoryPopup" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);width:1100px;max-width:99vw;background:rgba(34,34,34,0.93);border-radius:18px;box-shadow:0 8px 32px rgba(0,0,0,0.22);z-index:3000;padding:2.2rem 2.5rem 2.5rem 2.5rem;">
        <button class="close-btn" id="closeInventoryBtn" style="position:absolute;top:18px;right:24px;background:#0078d7;color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;">&times;</button>
        <h2 style="margin-top:0;margin-bottom:1.2rem;font-size:2.2rem;color:#fff;text-align:center;letter-spacing:1px;font-weight:bold;">Character Inventory</h2>
        <div class="equipment-inventory-container" style="display:flex;gap:32px;justify-content:center;align-items:flex-start;flex-wrap:wrap;">
            <div class="equipment-section" style="display:flex;flex-direction:row;align-items:center;min-width:520px;justify-content:center;">
                <!-- Left column: 4 slots -->
                <div class="equipment-slots-col" style="display:flex;flex-direction:column;gap:15px;">
                    <div class="equip-slot" id="head" style="width:64px;height:64px;background:#eaeaea;border:2px solid #bbb;border-radius:14px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;"><span class="equip-slot-label">Head</span></div>
                    <div class="equip-slot" id="body" style="width:64px;height:64px;background:#eaeaea;border:2px solid #bbb;border-radius:14px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;"><span class="equip-slot-label">Body</span></div>
                    <div class="equip-slot" id="legs" style="width:64px;height:64px;background:#eaeaea;border:2px solid #bbb;border-radius:14px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;"><span class="equip-slot-label">Legs</span></div>
                    <div class="equip-slot" id="boots" style="width:64px;height:64px;background:#eaeaea;border:2px solid #bbb;border-radius:14px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;"><span class="equip-slot-label">Boots</span></div>
                </div>
                <div class="equipment-avatar" id="equipmentAvatar" style="width:288px;height:384px;border-radius:18px;object-fit:contain;border:3px solid #0078d7;background:#fff;margin:0 32px;"></div>
                <div class="equipment-slots-col" style="display:flex;flex-direction:column;gap:15px;">
                    <div class="equip-slot" id="amulet" style="width:64px;height:64px;background:#eaeaea;border:2px solid #bbb;border-radius:14px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;"><span class="equip-slot-label">Amulet</span></div>
                    <div class="equip-slot" id="lring" style="width:64px;height:64px;background:#eaeaea;border:2px solid #bbb;border-radius:14px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;"><span class="equip-slot-label">L. Ring</span></div>
                    <div class="equip-slot" id="rring" style="width:64px;height:64px;background:#eaeaea;border:2px solid #bbb;border-radius:14px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;"><span class="equip-slot-label">R. Ring</span></div>
                    <div class="equip-slot" id="weapon" style="width:64px;height:64px;background:#eaeaea;border:2px solid #bbb;border-radius:14px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;"><span class="equip-slot-label">Weapon</span></div>
                </div>
            </div>
            <div class="inventory-section" style="flex:1;display:flex;flex-direction:column;align-items:center;width:520px;max-width:100%;box-sizing:border-box;">
                <div class="inventory-grid" id="inventoryGrid" style="display:grid;grid-template-columns:repeat(7,64px);grid-template-rows:repeat(5,64px);gap:8px;margin-top:20px;margin-left:0;"></div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="characterdata.js"></script>
    <script src="items.js"></script>
    <script>
        // --- Per-user character storage utilities (copied from characterselection.html) ---
        function getCurrentUsername() {
            return localStorage.getItem('currentUser') || null;
        }
        function getUserCharacterKey() {
            const username = getCurrentUsername();
            return username ? `savedCharacters_${username}` : 'savedCharacters';
        }
        function loadUserCharacters() {
            const key = getUserCharacterKey();
            return JSON.parse(localStorage.getItem(key) || '[]');
        }
        function saveUserCharacters(chars) {
            const key = getUserCharacterKey();
            localStorage.setItem(key, JSON.stringify(chars));
        }

        // Optional: Add button handlers
        const quitBtn = document.getElementById('quitGameBtn');
        if (quitBtn) {
            quitBtn.onclick = function() {
                window.location.href = 'characterselection.html';
            };
        }
        const walletBtn = document.getElementById('connectWalletBtn');
        const plaiBalanceSpan = document.getElementById('plaiBalance');
        let currentAccount = null;
        async function updateWalletUI(address) {
            if (walletBtn && address) {
                const short = address.slice(0, 6) + '....' + address.slice(-4);
                walletBtn.textContent = short;
            }
        }
        async function fetchPLAIBalance(address) {
            if (!window.ethers || !address) return;
            try {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const plaiAddress = "0x977EA2DDa60C1FdFfd4b0377b036D3871f2d01a9";
                const abi = ["function balanceOf(address) view returns (uint256)", "function decimals() view returns (uint8)"];
                const contract = new ethers.Contract(plaiAddress, abi, provider);
                const raw = await contract.balanceOf(address);
                // PLAI uses 6 decimals
                const balance = ethers.utils.formatUnits(raw, 6);
                if (plaiBalanceSpan) plaiBalanceSpan.textContent = balance;
            } catch (err) {
                if (plaiBalanceSpan) plaiBalanceSpan.textContent = '0.00';
            }
        }
        if (walletBtn) {
            walletBtn.onclick = async function() {
                if (typeof window.ethereum !== 'undefined') {
                    try {
                        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                        const account = accounts[0];
                        currentAccount = account;
                        await updateWalletUI(account);
                        await fetchPLAIBalance(account);
                    } catch (err) {
                        alert('Wallet connection failed: ' + err.message);
                    }
                } else {
                    alert('MetaMask is not installed. Please install MetaMask to connect your wallet.');
                }
            };
        }
        // Example: Set PLAI balance (replace with real value from wallet later, now handled by wallet connect)
        // document.getElementById('plaiBalance').textContent = '123.45';

        // Load selected character from URL param and localStorage
        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }
        function showSideCharInfo() {
            const idx = parseInt(getQueryParam('char'), 10);
            let char = null;
            if (!isNaN(idx)) {
                const saved = loadUserCharacters();
                if (saved[idx]) char = saved[idx];
            }
            // --- Ensure character object is complete and matches expected structure ---
            let needsSave = false;
            if (char) {
                // Default structure from characterdata.js
                const defaults = {
                    img: '',
                    characterclass: '',
                    level: 1,
                    xp: 0,
                    gold: 0,
                    statpoints: 0,
                    skillpoints: 0,
                    inventory: [],
                    equipped: {},
                };
                for (const key in defaults) {
                    if (!(key in char)) {
                        char[key] = defaults[key];
                        needsSave = true;
                    }
                }
                // Ensure equipped is an object
                if (typeof char.equipped !== 'object' || char.equipped === null) {
                    char.equipped = {};
                    needsSave = true;
                }
                // Ensure inventory is an array
                if (!Array.isArray(char.inventory)) {
                    char.inventory = [];
                    needsSave = true;
                }
                if (needsSave) {
                    // Save back the fixed character object
                    const chars = loadUserCharacters();
                    chars[idx] = char;
                    saveUserCharacters(chars);
                }
                // ...existing code for rendering side menu...
                const img = document.getElementById('sideCharImg');
                const lvl = document.getElementById('sideCharLevel');
                const cls = document.getElementById('sideCharClass');
                img.src = char.img;
                img.alt = char.characterclass;
                img.style.display = '';
                lvl.textContent = 'Level ' + char.level;
                lvl.style.display = '';
                cls.textContent = char.characterclass;
                cls.style.display = '';
                // XP Progression Bar (update existing bar)
                let xpBar = document.getElementById('sideCharXPBar');
                let xpFill = document.getElementById('xpFill');
                let xpText = document.getElementById('xpText');
                if (xpBar && xpFill && xpText) {
                    xpBar.style.display = '';
                    const neededXP = char.level * 100;
                    const percent = Math.min(100, Math.round((char.xp / neededXP) * 100));
                    xpFill.style.width = percent + '%';
                    xpText.textContent = `${char.xp} / ${neededXP} XP`;
                }
                // Character properties below XP bar
                let propDiv = document.getElementById('sideCharProps');
                if (propDiv) {
                    propDiv.style.display = '';
                    propDiv.innerHTML = `
                        <div style='margin-bottom:6px;'><span style='color:#ffd700;'>Gold:</span> ${char.gold}</div>
                        <div style='margin-bottom:6px;'><span style='color:#7adf7a;'>Statpoints:</span> ${char.statpoints}</div>
                        <div><span style='color:#7ab7df;'>Skillpoints:</span> ${char.skillpoints}</div>
                    `;
                }
            }
        }
        showSideCharInfo();

        // Add inventory popup open/close logic
        (function() {
            const openBtn = document.getElementById('sideInventoryBtn');
            const popup = document.getElementById('inventoryPopup');
            const closeBtn = document.getElementById('closeInventoryBtn');
            if (openBtn && popup && closeBtn) {
                openBtn.addEventListener('click', function() {
                    popup.style.display = '';
                    // Set character image in inventory popup
                    const equipmentAvatar = document.getElementById('equipmentAvatar');
                    let char = null;
                    const idx = parseInt(getQueryParam('char'), 10);
                    if (!isNaN(idx)) {
                        const saved = loadUserCharacters();
                        if (saved[idx]) char = saved[idx];
                    }
                    if (equipmentAvatar) {
                        if (char && char.img) {
                            equipmentAvatar.innerHTML = `<img src="${char.img}" alt="Character" style="width:100%;height:100%;object-fit:contain;border-radius:14px;">`;
                        } else {
                            equipmentAvatar.innerHTML = '';
                        }
                    }
                    // Equipment state
                    if (!char.equipped) char.equipped = {};
                    // Define onUnequip and onEquip once
                    function onUnequip(slotType) {
                        if (char.equipped[slotType]) {
                            char.inventory.push(char.equipped[slotType]);
                            char.equipped[slotType] = null;
                            // Save per-user characters
                            const chars = loadUserCharacters();
                            chars[idx] = char;
                            saveUserCharacters(chars);
                            renderEquipment(char.equipped, onUnequip);
                            renderInventoryGrid(char.inventory, char.equipped, onEquip);
                        }
                    }
                    function onEquip(itemId, invIdx) {
                        const itemDefs = window.items || [];
                        const def = itemDefs.find(d => d.id === itemId);
                        if (!def) return;
                        // Use item type directly as slotType
                        const slotTypes = ['head', 'body', 'legs', 'boots', 'amulet', 'lring', 'rring', 'weapon'];
                        const slotType = def.type;
                        if (slotTypes.includes(slotType)) {
                            if (!char.equipped) char.equipped = {};
                            if (char.equipped[slotType]) {
                                // Already equipped, swap
                                char.inventory[invIdx] = char.equipped[slotType];
                            } else {
                                char.inventory.splice(invIdx, 1);
                            }
                            char.equipped[slotType] = itemId;
                            // Save per-user characters
                            const chars = loadUserCharacters();
                            chars[idx] = char;
                            saveUserCharacters(chars);
                            renderEquipment(char.equipped, onUnequip);
                            renderInventoryGrid(char.inventory, char.equipped, onEquip);
                        }
                    }
                    renderEquipment(char.equipped, onUnequip);
                    renderInventoryGrid(char.inventory, char.equipped, onEquip);
                });
                closeBtn.addEventListener('click', function() {
                    popup.style.display = 'none';
                });
                // Close on Escape
                document.addEventListener('keydown', function(e) {
                    if (popup.style.display !== 'none' && (e.key === 'Escape' || e.key === 'Esc')) {
                        popup.style.display = 'none';
                    }
                });
            }
        })();

        // Populate inventory grid with 35 empty slots (7x5)
        function renderInventoryGrid(items, equipped, onEquip) {
            const grid = document.getElementById('inventoryGrid');
            grid.innerHTML = '';
            const itemDefs = window.items || [];
            for (let i = 0; i < 35; i++) {
                let slot = document.createElement('div');
                slot.className = 'inventory-slot';
                slot.style.width = '64px';
                slot.style.height = '64px';
                slot.style.background = '#eaeaea';
                slot.style.border = '2px solid #bbb';
                slot.style.borderRadius = '14px';
                slot.style.display = 'flex';
                slot.style.alignItems = 'center';
                slot.style.justifyContent = 'center';
                slot.style.position = 'relative';
                slot.style.overflow = 'hidden';
                // Show item if present
                if (items[i]) {
                    const itemId = items[i];
                    const def = itemDefs.find(d => d.id === itemId);
                    if (def) {
                        const img = document.createElement('img');
                        img.src = def.icon;
                        img.alt = def.name;
                        img.title = def.name;
                        img.style.width = '64px';
                        img.style.height = '64px';
                        img.style.objectFit = 'contain';
                        img.style.cursor = 'pointer';
                        img.onclick = function() {
                            if (onEquip) onEquip(itemId, i);
                        };
                        slot.appendChild(img);
                    } else {
                        slot.textContent = itemId;
                    }
                }
                grid.appendChild(slot);
            }
        }

        // Use slotTypes as both the slot type list and the slot IDs
        const slotTypes = ['head', 'body', 'legs', 'boots', 'amulet', 'lring', 'rring', 'weapon'];

        function renderEquipment(equipped, onUnequip) {
            const itemDefs = window.items || [];
            slotTypes.forEach((type) => {
                const slot = document.getElementById(type);
                if (!slot) return;
                // Always clear slot but keep label for later
                let label = slot.querySelector('.equip-slot-label');
                let labelText = label ? label.textContent : null;
                slot.innerHTML = '';
                const itemId = equipped[type];
                if (itemId) {
                    const def = itemDefs.find(d => d.id === itemId);
                    if (def) {
                        // Hide label when item is equipped
                        if (labelText) {
                            let labelEl = document.createElement('span');
                            labelEl.className = 'equip-slot-label';
                            labelEl.textContent = labelText;
                            labelEl.style.display = 'none';
                            slot.appendChild(labelEl);
                        }
                        const img = document.createElement('img');
                        img.src = def.icon;
                        img.alt = def.name;
                        img.title = def.name;
                        img.style.width = '64px';
                        img.style.height = '64px';
                        img.style.objectFit = 'contain';
                        img.style.cursor = 'pointer';
                        img.onclick = function() {
                            if (onUnequip) onUnequip(type);
                        };
                        slot.appendChild(img);
                    }
                } else {
                    // Show label when no item is equipped
                    if (labelText) {
                        let labelEl = document.createElement('span');
                        labelEl.className = 'equip-slot-label';
                        labelEl.textContent = labelText;
                        labelEl.style.display = '';
                        slot.appendChild(labelEl);
                    }
                }
            });
        }
    </script>
</body>
</html>
